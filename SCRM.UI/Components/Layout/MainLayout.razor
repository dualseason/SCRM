@inherits LayoutComponentBase
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Authorization
@using Blazored.LocalStorage
@using SCRM.UI.Services
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider

<RadzenComponents />

<RadzenLayout style="height: 100vh">
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0">
            <RadzenSidebarToggle Click="@(() => sidebarExpanded = !sidebarExpanded)" />
            <RadzenLabel Text="SCRM" />
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Style="margin-left: auto; margin-right: 1rem;">
                <AuthorizeView>
                    <Authorized>
                        <RadzenText TextStyle="TextStyle.Body1" Style="color: white;">@context.User.Identity?.Name</RadzenText>
                        <RadzenButton Text="退出" Icon="logout" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small" Click="@Logout" />
                    </Authorized>
                    <NotAuthorized>
                        <RadzenLink Path="login" Text="登录" Style="color: white;" />
                    </NotAuthorized>
                </AuthorizeView>
            </RadzenStack>
        </RadzenStack>
    </RadzenHeader>
    <RadzenSidebar Responsive="false" Style="width: max-content" @bind-Expanded="@sidebarExpanded">
        <RadzenPanelMenu DisplayStyle="@(sidebarExpanded ? MenuItemDisplayStyle.IconAndText : MenuItemDisplayStyle.Icon)" ShowArrow="false">
             <AuthorizeView>
                <Authorized>
                    <RadzenPanelMenuItem Text="Home" Path="" Icon="home" />
                    <RadzenPanelMenuItem Text="Chat" Path="chat" Icon="chat" />
                    <RadzenPanelMenuItem Text="Contacts" Path="contacts" Icon="contacts" />
                </Authorized>
            </AuthorizeView>
        </RadzenPanelMenu>
    </RadzenSidebar>
    <RadzenBody>
        <div class="rz-p-4">
            @Body
        </div>
    </RadzenBody>
    <RadzenFooter>
        <RadzenText TextStyle="TextStyle.Body2" TextAlign="TextAlign.Center" Text="&copy; 2025 SCRM" />
    </RadzenFooter>
</RadzenLayout>

@code {
    bool sidebarExpanded = true;
    [Inject] WeChatService WeChatService { get; set; }
    [Inject] HttpClient HttpClient { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var hubUrl = new Uri(HttpClient.BaseAddress!, "hubs/client").ToString();
        await WeChatService.InitializeAsync(hubUrl);
    }

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");
        await AuthStateProvider.GetAuthenticationStateAsync();
        Navigation.NavigateTo("/login");
    }
}
