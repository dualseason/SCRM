@using SCRM.UI.Services
@using SCRM.API.Models.Entities
@inject WeChatService WeChatService
@inject DialogService DialogService
@inject NotificationService NotificationService
@implements IAsyncDisposable

<div style="display: flex; flex-direction: column; gap: 20px;">
    <!-- Screenshot Section -->
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Screenshot</RadzenText>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <RadzenButton Text="Take Screenshot" Icon="camera_alt" Click="@RequestScreenshot" IsBusy="@isTakingScreenshot" />
        </div>
        @if (!string.IsNullOrEmpty(screenshotUrl))
        {
            <div style="text-align: center; border: 1px solid #eee; padding: 10px;">
                <RadzenImage Path="@screenshotUrl" Style="max-width: 100%; max-height: 400px;" />
            </div>
        }
    </RadzenCard>

    <!-- System Actions Section -->
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">System Actions</RadzenText>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            <RadzenButton Text="Clean App Cache" Icon="cleaning_services" ButtonStyle="ButtonStyle.Info" Click="@(() => ExecuteAction(4, "Clean App Cache"))" />
            <RadzenButton Text="Clean WeChat Cache" Icon="delete_sweep" ButtonStyle="ButtonStyle.Info" Click="@(() => ExecuteAction(5, "Clean WeChat Cache"))" />
            <RadzenButton Text="Restart WeChat" Icon="restart_alt" ButtonStyle="ButtonStyle.Warning" Click="@(() => ExecuteAction(9, "Restart WeChat"))" />
             <RadzenButton Text="Reboot Phone" Icon="power_settings_new" ButtonStyle="ButtonStyle.Danger" Click="@(() => ExecuteAction(1, "Reboot Phone"))" />
        </div>
    </RadzenCard>
</div>

@code {
    [Parameter] public string ConnectionId { get; set; }
    
    string screenshotUrl;
    bool isTakingScreenshot;

    protected override async Task OnInitializedAsync()
    {
        await WeChatService.JoinGroupAsync(ConnectionId);
        WeChatService.OnScreenShotReceived += HandleScreenshot;
    }

    public async ValueTask DisposeAsync()
    {
        WeChatService.OnScreenShotReceived -= HandleScreenshot;
        await WeChatService.LeaveGroupAsync(ConnectionId);
    }

    async Task RequestScreenshot()
    {
        isTakingScreenshot = true;
        screenshotUrl = null;
        
        // Timeout Logic
        var timeoutMs = 15000; // 15 seconds
        var task = WeChatService.RequestScreenShotAsync(ConnectionId);
        
        if (await Task.WhenAny(task, Task.Delay(timeoutMs)) == task)
        {
            // Task completed within timeout
            var success = await task;
            if (!success)
            {
                isTakingScreenshot = false;
                NotificationService.Notify(NotificationSeverity.Error, "Failed", "Could not send screenshot request.");
            }
            // If success, wait for event (spinner is cleared in HandleScreenshot)
            // But we should also have a failsafe if event never comes?
            // Actually, RequestScreenShotAsync only returns *if the command was sent*.
            // The image comes back via SignalR event later.
            // So we need a second timeout for the *image reception*.
            
            // Let's implement a secondary wait for the image
             _ = Task.Run(async () => 
            {
                await Task.Delay(timeoutMs);
                if (isTakingScreenshot && string.IsNullOrEmpty(screenshotUrl))
                {
                    await InvokeAsync(() => 
                    {
                        if (isTakingScreenshot) // Double check check
                        {
                            isTakingScreenshot = false;
                            NotificationService.Notify(NotificationSeverity.Warning, "Timeout", "Screenshot capture timed out (no response).");
                            StateHasChanged();
                        }
                    });
                }
            });
        }
        else
        {
            // Timeout sending the command (connection issue)
            isTakingScreenshot = false;
            NotificationService.Notify(NotificationSeverity.Error, "Timeout", "Request timed out.");
        }
    }

    void HandleScreenshot(string url)
    {
        screenshotUrl = url;
        isTakingScreenshot = false;
        InvokeAsync(StateHasChanged);
    }

    async Task ExecuteAction(int action, string actionName)
    {
        var confirmed = await DialogService.Confirm($"Are you sure you want to {actionName}?", "Confirm Action", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });
        if (confirmed == true)
        {
            var success = await WeChatService.ExecutePhoneActionAsync(ConnectionId, action);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Sent", $"{actionName} command sent.");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Failed", $"Could not send {actionName} command.");
            }
        }
    }
}


