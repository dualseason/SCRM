@page "/login"
@using SCRM.UI.Services
@using SCRM.Models.Dtos
@using Microsoft.AspNetCore.Components.Authorization
@using Blazored.LocalStorage
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ILocalStorageService LocalStorage
@inject NotificationService NotificationService

<PageTitle>登录 - SCRM</PageTitle>

<div class="rz-p-12 rz-text-align-center" style="height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #f5f5f5;">
    <RadzenCard style="width: 400px; padding: 2rem;">
        <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" Class="rz-mb-4">SCRM 登录</RadzenText>
        
        <RadzenTemplateForm Data="@loginModel" Submit="@(async (LoginRequest args) => await HandleLogin(args))">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="用户名" Variant="Variant.Outlined">
                    <RadzenTextBox Name="UserName" @bind-Value="loginModel.UserName" Style="width: 100%" />
                    <RadzenRequiredValidator Component="UserName" Text="请输入用户名" />
                </RadzenFormField>

                <RadzenFormField Text="密码" Variant="Variant.Outlined">
                    <RadzenPassword Name="Password" @bind-Value="loginModel.Password" Style="width: 100%" />
                    <RadzenRequiredValidator Component="Password" Text="请输入密码" />
                </RadzenFormField>

                <RadzenButton ButtonType="ButtonType.Submit" Text="登录" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" IsBusy="@isBusy" />
            </RadzenStack>
        </RadzenTemplateForm>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Variant="Variant.Flat" Shade="Shade.Lighter" Class="rz-mt-4">
                @errorMessage
            </RadzenAlert>
        }
    </RadzenCard>
</div>

@code {
    private LoginRequest loginModel = new LoginRequest();
    private bool isBusy = false;
    private string errorMessage = string.Empty;
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private async Task HandleLogin(LoginRequest request)
    {
        isBusy = true;
        errorMessage = string.Empty;

        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/login", request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ApiResponse<TokenResponse>>();
                if (result != null && result.Success && result.Data != null)
                {
                    await LocalStorage.SetItemAsStringAsync("authToken", result.Data.Token);
                    await AuthStateProvider.GetAuthenticationStateAsync();
                    Navigation.NavigateTo(ReturnUrl ?? "/");
                }
                else
                {
                    errorMessage = result?.Message ?? "登录失败";
                }
            }
            else
            {
                var errorResult = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();
                errorMessage = errorResult?.Message ?? "登录请求失败";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"发生错误: {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    public class LoginRequest
    {
        public string UserName { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

  }
