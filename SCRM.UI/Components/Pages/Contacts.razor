@page "/contacts"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using SCRM.API.Models.Entities
@using SCRM.UI.Services
@using Radzen
@using Radzen.Blazor
@inject NotificationService NotificationService
@inject WeChatService WeChatService

<div class="row">
    <div class="col-md-12">
        <RadzenCard Style="margin-bottom: 20px;">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Select Device</RadzenText>
                    <RadzenDropDown Data="@clients" ValueProperty="uuid" 
                                    @bind-Value="selectedClientUuid" Change="@OnClientSelected" 
                                    Style="width: 100%;" Placeholder="Select a device..." >
                        <Template Context="client">
                            @($"{client.device?.hsman} {client.device?.hstype} ({client.WeChatNick ?? "Unknown"})")
                        </Template>
                    </RadzenDropDown>
                </div>
                <div class="col-md-8" style="display: flex; align-items: center;">
                    @if (selectedClient != null)
                    {
                        <RadzenIcon Icon="account_circle" Style="margin-right: 5px;" />
                        <div>
                            <div style="font-weight: bold;">@(selectedClient.WeChatNick ?? "Unknown")</div>
                            <div style="font-size: 0.8em; color: #666;">@(selectedClient.WeChatId ?? "Not logged in")</div>
                        </div>
                    }
                </div>
            </div>
        </RadzenCard>

        @if (contacts != null)
        {
            <RadzenDataGrid Data="@contacts" TItem="Contact" AllowFiltering="true" AllowPaging="true" PageSize="10" AllowSorting="true">
                <Columns>
                    <RadzenDataGridColumn TItem="Contact" Title="Avatar" Sortable="false" Filterable="false" Width="60px">
                        <Template Context="data">
                            <RadzenImage Path="@data.Avatar" Style="width: 40px; height: 40px; border-radius: 50%;" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Contact" Property="Nickname" Title="Nickname" />
                    <RadzenDataGridColumn TItem="Contact" Property="Remarks" Title="Remarks" />
                    <RadzenDataGridColumn TItem="Contact" Property="Wxid" Title="WeChat ID" />
                    <RadzenDataGridColumn TItem="Contact" Property="Gender" Title="Gender" Width="80px">
                        <Template Context="data">
                            @(data.Gender == 1 ? "Male" : (data.Gender == 2 ? "Female" : "Unknown"))
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Contact" Property="Province" Title="Province" />
                    <RadzenDataGridColumn TItem="Contact" Property="City" Title="City" />
                    <RadzenDataGridColumn TItem="Contact" Property="Phone" Title="Phone" />
                    <RadzenDataGridColumn TItem="Contact" Property="Signature" Title="Signature" />
                </Columns>
            </RadzenDataGrid>
        }
        else if (!string.IsNullOrEmpty(selectedClientUuid))
        {
            <div style="padding: 20px; text-align: center;">
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText TextStyle="TextStyle.Body1" Style="margin-top: 10px;">Loading contacts...</RadzenText>
            </div>
        }
    </div>
</div>

@code {
    IEnumerable<SrClient> clients;
    IEnumerable<Contact> contacts;
    SrClient selectedClient;
    string selectedClientUuid;

    protected override async Task OnInitializedAsync()
    {
        // SignalRService is now initialized in MainLayout
        await LoadClients();
    }

    async Task LoadClients()
    {
        clients = await WeChatService.GetDevicesAsync();
    }

    async Task OnClientSelected(object value)
    {
        var uuid = value as string;
        selectedClient = clients.FirstOrDefault(c => c.uuid == uuid);
        contacts = null;

        if (selectedClient != null && selectedClient.WechatAccountId.HasValue)
        {
            contacts = await WeChatService.GetContactsAsync(selectedClient.WechatAccountId.Value);
        }
    }

    // DisposeAsync removed as it is a Shared service
}
