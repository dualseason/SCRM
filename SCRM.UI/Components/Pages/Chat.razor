@page "/chat"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using SCRM.API.Models.Entities
@using SCRM.UI.Services
@using Radzen
@using Radzen.Blazor
@inject NotificationService NotificationService
@inject CrmStore Store
@implements IDisposable

<RadzenLayout Style="height: calc(100vh - 60px); display: flex; flex-direction: row; overflow: hidden;">
    
    <!-- Left Pane: Devices -->
    <RadzenSidebar Style="width: 250px; background-color: #f0f2f5; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">
        <RadzenPanelMenu Style="width: 100%; height: 100%;">
            <div style="padding: 10px; border-bottom: 1px solid #ddd; background-color: #e9ecef;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3" Style="margin: 0;">Devices</RadzenText>
            </div>
            <div style="flex: 1; overflow-y: auto;">
                <RadzenListBox Data="@Store.Devices" Value="@Store.SelectedDevice" 
                               ValueProperty="uuid"
                               Change="@(args => SelectDevice(args))"
                               Style="width: 100%; height: 100%; border: none; background-color: transparent;">
                    <Template Context="device">
                        <div style="display: flex; align-items: center; padding: 5px;">
                            <RadzenIcon Icon="smartphone" Style="margin-right: 10px; color: #555;" />
                            <div style="overflow: hidden;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @(device.WeChatNick ?? device.device?.hsman ?? "Unknown")
                                </div>
                                <div style="font-size: 0.8em; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @(device.WeChatId ?? "Offline")
                                </div>
                            </div>
                        </div>
                    </Template>
                </RadzenListBox>
            </div>
        </RadzenPanelMenu>
    </RadzenSidebar>

    <!-- Middle Pane: Contacts -->
    <RadzenSidebar Style="width: 300px; background-color: #ffffff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">
        @if (Store.SelectedDevice != null)
        {
             <div style="padding: 10px; border-bottom: 1px solid #eee;">
                <RadzenTextBox Placeholder="Search friends..." Style="width: 100%;" />
            </div>
            <div style="flex: 1; overflow-y: auto;">
                 <RadzenListBox Data="@Store.Contacts" Value="@Store.SelectedContact"
                               ValueProperty="Wxid"
                               Change="@(args => SelectContact(args))"
                               Style="width: 100%; height: 100%; border: none;">
                    <Template Context="contact">
                        <div style="display: flex; align-items: center; padding: 5px;">
                            <RadzenImage Path="@(contact.Avatar)" Style="width: 40px; height: 40px; border-radius: 4px; margin-right: 10px;" />
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 500; font-size: 0.95em;">@contact.Nickname</div>
                                <div style="font-size: 0.8em; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @contact.Wxid
                                </div>
                            </div>
                        </div>
                    </Template>
                 </RadzenListBox>
            </div>
        }
        else
        {
             <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                Select a device
             </div>
        }
    </RadzenSidebar>

    <!-- Right Pane: Chat -->
    <RadzenBody Style="flex: 1; background-color: #f5f5f5; display: flex; flex-direction: column; padding: 0;">
        @if (Store.SelectedContact != null)
        {
            <!-- Chat Header -->
            <div style="padding: 15px; background-color: white; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center;">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; flex: 1;">
                    @Store.SelectedContact.Nickname <span style="font-size: 0.8em; color: #888;">(@Store.SelectedContact.Wxid)</span>
                </RadzenText>
            </div>

            <!-- Chat History -->
            <div id="chat-scroller" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;">
                @if (Store.ChatHistory.TryGetValue(Store.SelectedContact.Wxid, out var messages))
                {
                    @foreach (var msg in messages)
                    {
                        <div style="margin-bottom: 15px; display: flex; justify-content: @(msg.Direction == 1 ? "flex-end" : "flex-start");">
                            <div style="max-width: 70%; padding: 10px 15px; border-radius: 8px; 
                                        background-color: @(msg.Direction == 1 ? "#95ec69" : "#ffffff"); 
                                        color: #000; box-shadow: 0 1px 1px rgba(0,0,0,0.05);">
                                <div style="white-space: pre-wrap; word-break: break-word;">@msg.Content</div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Input Area -->
            <div style="padding: 15px; background-color: white; border-top: 1px solid #e0e0e0;">
                 <RadzenTextArea @bind-Value="messageInput" Rows="3" Style="width: 100%; margin-bottom: 10px; border: 1px solid #ddd;" Placeholder="Type a message..." @onkeydown="@Enter" />
                 <div style="text-align: right;">
                     <RadzenButton Text="Send" Click="@SendMessage" ButtonStyle="ButtonStyle.Success" Icon="send" Disabled="@(string.IsNullOrWhiteSpace(messageInput))" />
                 </div>
            </div>
        }
        else
        {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc;">
                <div style="text-align: center;">
                    <RadzenIcon Icon="chat" Style="font-size: 4em; color: #ddd; margin-bottom: 10px;" />
                    <RadzenText TextStyle="TextStyle.H5" style="color: #999;">Select a contact to start chatting</RadzenText>
                </div>
            </div>
        }
    </RadzenBody>
</RadzenLayout>

@code {
    string messageInput = "";

    protected override async Task OnInitializedAsync()
    {
        Store.OnChange += StateHasChanged;
        await Store.InitializeAsync();
    }

    void SelectDevice(object value)
    {
        // Value is UUID because ValueProperty="uuid"
        if (value is string uuid)
        {
            var device = Store.Devices.FirstOrDefault(d => d.uuid == uuid);
            if (device != null)
            {
                _ = Store.SelectDeviceAsync(device);
            }
        }
    }

    void SelectContact(object value)
    {
        if (value is string wxid)
        {
            var contact = Store.Contacts.FirstOrDefault(c => c.Wxid == wxid);
            if (contact != null)
            {
                _ = Store.SelectContactAsync(contact);
            }
        }
    }

    async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput)) return;
        await Store.SendMessageAsync(messageInput);
        messageInput = "";
    }

    async Task Enter(KeyboardEventArgs e)
    {
        if ((e.Code == "Enter" || e.Code == "NumpadEnter") && !e.CtrlKey)
        {
            await SendMessage();
        }
    }

    public void Dispose()
    {
        Store.OnChange -= StateHasChanged;
    }
}
