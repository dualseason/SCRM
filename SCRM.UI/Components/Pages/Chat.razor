@page "/chat"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using SCRM.API.Models.Entities
@using SCRM.UI.Services
@using SCRM.UI.Components.Dialogs
@using Radzen
@using Radzen.Blazor
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ContextMenuService ContextMenuService
@inject WeChatService WeChatService
@inject CrmStore Store
@implements IDisposable

<RadzenLayout Style="height: calc(100vh - 60px); display: flex; flex-direction: row; overflow: hidden;">
    
    <!-- Left Pane: Devices -->
    <RadzenSidebar Style="width: 250px; background-color: #f0f2f5; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">
        <RadzenPanelMenu Style="width: 100%; height: 100%;">
            <div style="padding: 10px; border-bottom: 1px solid #ddd; background-color: #e9ecef;">
                <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3" Style="margin: 0;">Devices</RadzenText>
            </div>
            <div style="flex: 1; overflow-y: auto;">
                <RadzenListBox Data="@Store.Devices" Value="@Store.SelectedDevice" 
                               ValueProperty="uuid"
                               Change="@(args => SelectDevice(args))"
                               Style="width: 100%; height: 100%; border: none; background-color: transparent;">
                    <Template Context="device">
                       <div style="display: flex; align-items: center; padding: 5px; width: 100%;">
                            <RadzenIcon Icon="smartphone" Style="margin-right: 10px; color: #555;" />
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @(device.WeChatNick ?? device.device?.hsman ?? "Unknown")
                                </div>
                                <div style="font-size: 0.8em; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @(device.WeChatId ?? "Offline")
                                </div>
                            </div>
                            <RadzenButton Icon="settings_remote" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@(args => OpenDeviceControl(device))" @onclick:stopPropagation="true" Style="margin-left: 5px;" />
                        </div>
                    </Template>
                </RadzenListBox>
            </div>
        </RadzenPanelMenu>
    </RadzenSidebar>

    <!-- Middle Pane: Contacts -->
    <RadzenSidebar Style="width: 300px; background-color: #ffffff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">
        @if (Store.SelectedDevice != null)
        {
             <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                <RadzenTextBox Placeholder="Search friends..." Style="flex: 1; margin-right: 5px;" />
                <RadzenSplitButton Text="Sync" Click="@(async (args) => await SyncDetails(args))" Icon="sync" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small">
                    <ChildContent>
                        <RadzenSplitButtonItem Text="Sync Friends" Value="friends" Icon="people" />
                        <RadzenSplitButtonItem Text="Sync Groups" Value="groups" Icon="groups" />
                        <RadzenSplitButtonItem Text="Sync Moments" Value="moments" Icon="camera" />
                        <RadzenSplitButtonItem Text="Friend Requests" Value="requests" Icon="person_add" />
                    </ChildContent>
                </RadzenSplitButton>
            </div>
            <div style="flex: 1; overflow-y: auto;">
                 <RadzenListBox Data="@Store.Contacts" Value="@Store.SelectedContact"
                               ValueProperty="Wxid"
                               Change="@(args => SelectContact(args))"
                               Style="width: 100%; height: 100%; border: none;">
                    <Template Context="contact">
                        <div style="display: flex; align-items: center; padding: 5px; width: 100%;">
                            <RadzenImage Path="@(contact.Avatar)" Style="width: 40px; height: 40px; border-radius: 4px; margin-right: 10px;" />
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: 500; font-size: 0.95em;">@contact.Nickname</div>
                                <div style="font-size: 0.8em; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @contact.Wxid
                                </div>
                            </div>
                             <RadzenButton Icon="more_vert" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@(args => ShowContactContextMenu(args, contact))" @onclick:stopPropagation="true" Style="margin-left: 5px;" />
                        </div>
                    </Template>
                 </RadzenListBox>
            </div>
        }
        else
        {
             <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                Select a device
             </div>
        }
    </RadzenSidebar>

    <!-- Right Pane: Chat -->
    <RadzenBody Style="flex: 1; background-color: #f5f5f5; display: flex; flex-direction: column; padding: 0;">
        @if (Store.SelectedContact != null)
        {
            <!-- Chat Header -->
            <div style="padding: 15px; background-color: white; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center;">
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; flex: 1;">
                    @Store.SelectedContact.Nickname <span style="font-size: 0.8em; color: #888;">(@Store.SelectedContact.Wxid)</span>
                </RadzenText>
                 @if (Store.SelectedContact.Wxid.EndsWith("@chatroom"))
                {
                    <RadzenButton Icon="settings" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@OpenGroupSettings" />
                }
            </div>

            <!-- Chat History -->
            <div id="chat-scroller" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;">
                @if (Store.ChatHistory.TryGetValue(Store.SelectedContact.Wxid, out var messages))
                {
                    @foreach (var msg in messages)
                    {
                        <div style="margin-bottom: 15px; display: flex; justify-content: @(msg.Direction == 1 ? "flex-end" : "flex-start");">
                            <div style="max-width: 70%; padding: 10px 15px; border-radius: 8px; 
                                        background-color: @(msg.Direction == 1 ? "#95ec69" : "#ffffff"); 
                                        color: #000; box-shadow: 0 1px 1px rgba(0,0,0,0.05);">
                                <div style="white-space: pre-wrap; word-break: break-word;">@msg.Content</div>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Input Area -->
            <div style="padding: 15px; background-color: white; border-top: 1px solid #e0e0e0;">
                 <RadzenTextArea @bind-Value="messageInput" Rows="3" Style="width: 100%; margin-bottom: 10px; border: 1px solid #ddd;" Placeholder="Type a message..." @onkeydown="@Enter" />
                 <div style="text-align: right;">
                     <RadzenButton Text="Send" Click="@SendMessage" ButtonStyle="ButtonStyle.Success" Icon="send" Disabled="@(string.IsNullOrWhiteSpace(messageInput))" />
                 </div>
            </div>
        }
        else
        {
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc;">
                <div style="text-align: center;">
                    <RadzenIcon Icon="chat" Style="font-size: 4em; color: #ddd; margin-bottom: 10px;" />
                    <RadzenText TextStyle="TextStyle.H5" style="color: #999;">Select a contact to start chatting</RadzenText>
                </div>
            </div>
        }
    </RadzenBody>
</RadzenLayout>

@code {
    string messageInput = "";

    protected override async Task OnInitializedAsync()
    {
        Store.OnChange += StateHasChanged;
        await Store.InitializeAsync();
    }

    void SelectDevice(object value)
    {
        // Value is UUID because ValueProperty="uuid"
        if (value is string uuid)
        {
            var device = Store.Devices.FirstOrDefault(d => d.uuid == uuid);
            if (device != null)
            {
                _ = Store.SelectDeviceAsync(device);
            }
        }
    }

    void SelectContact(object value)
    {
        if (value is string wxid)
        {
            var contact = Store.Contacts.FirstOrDefault(c => c.Wxid == wxid);
            if (contact != null)
            {
                _ = Store.SelectContactAsync(contact);
            }
        }
    }

    async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput)) return;
        await Store.SendMessageAsync(messageInput);
        messageInput = "";
    }

    async Task Enter(KeyboardEventArgs e)
    {
        if ((e.Code == "Enter" || e.Code == "NumpadEnter") && !e.CtrlKey)
        {
            await SendMessage();
        }
    }

    async Task SyncDetails(RadzenSplitButtonItem item)
    {
        if (item == null || item.Value == "friends") 
        {
            await Store.SyncContactsAsync();
            NotificationService.Notify(NotificationSeverity.Info, "Sync Started", "Friends sync triggered.");
            return;
        }

        switch (item.Value)
        {
            case "groups":
                await Store.SyncChatRoomsAsync();
                NotificationService.Notify(NotificationSeverity.Info, "Sync Started", "Groups sync triggered.");
                break;
            case "moments":
                await Store.SyncMomentsAsync();
                NotificationService.Notify(NotificationSeverity.Info, "Sync Started", "Moments sync triggered.");
                break;
            case "requests":
                await OpenFriendRequests();
                break;
        }
    }

    // --- Device Context Menu ---
    void ShowDeviceContextMenu(MouseEventArgs args, SrClient device)
    {
        ContextMenuService.Open(args, new List<ContextMenuItem>
        {
            new ContextMenuItem { Text = "Control Panel", Value = 1, Icon = "settings_remote" },
            // Add more items if needed
        }, async (e) => 
        {
            if ((int)e.Value == 1)
            {
                await OpenDeviceControl(device);
            }
        });
    }

    async Task OpenDeviceControl(SrClient device)
    {
        await DialogService.OpenAsync<DeviceControlDialog>($"Control Panel - {device.WeChatNick}",
               new Dictionary<string, object>() { { "ConnectionId", device.ConnectionId } },
               new DialogOptions() { Width = "600px", Height = "600px" });
    }

    // --- Contact Context Menu ---
    void ShowContactContextMenu(MouseEventArgs args, Contact contact)
    {
        ContextMenuService.Open(args, new List<ContextMenuItem>
        {
            new ContextMenuItem { Text = "View Details", Value = 1, Icon = "info" },
            new ContextMenuItem { Text = "Delete Friend", Value = 2, Icon = "delete_forever" }
        }, async (e) => 
        {
            if ((int)e.Value == 1)
            {
                await DialogService.OpenAsync<ContactDetailDialog>($"Details - {contact.Nickname}",
                    new Dictionary<string, object>() { { "Contact", contact } },
                     new DialogOptions() { Width = "400px" });
            }
            else if ((int)e.Value == 2)
            {
                 await DeleteFriend(contact);
            }
        });
    }

    async Task DeleteFriend(Contact contact)
    {
         var confirmed = await DialogService.Confirm($"Are you sure you want to delete {contact.Nickname}?", "Delete Friend", new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel" });
         if (confirmed == true)
         {
             if (Store.SelectedDevice != null)
             {
                 var success = await WeChatService.DeleteFriendAsync(Store.SelectedDevice.ConnectionId, contact.Wxid);
                 if (success)
                 {
                     NotificationService.Notify(NotificationSeverity.Success, "Deleted", $"Delete request sent for {contact.Nickname}.");
                 }
                 else
                 {
                     NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to send delete request.");
                 }
             }
         }
    }

    // --- Header Actions ---
    async Task OpenFriendRequests()
    {
        if (Store.SelectedDevice == null) return;
         await DialogService.OpenAsync<FriendRequestsDialog>($"Accept Friend Request",
               new Dictionary<string, object>() { { "ConnectionId", Store.SelectedDevice.ConnectionId } },
               new DialogOptions() { Width = "400px" });
    }

    async Task OpenGroupSettings()
    {
        if (Store.SelectedDevice == null || Store.SelectedContact == null) return;
        
        await DialogService.OpenAsync<GroupSettingsDialog>($"Group Settings - {Store.SelectedContact.Nickname}",
               new Dictionary<string, object>() { 
                   { "ConnectionId", Store.SelectedDevice.ConnectionId },
                   { "ChatRoomId", Store.SelectedContact.Wxid },
                   { "CurrentGroupName", Store.SelectedContact.Nickname }
               },
               new DialogOptions() { Width = "500px" });
    }

    public void Dispose()
    {
        Store.OnChange -= StateHasChanged;
    }
}
