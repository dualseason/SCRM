@page "/chat"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using SCRM.API.Models.Entities
@using SCRM.UI.Services
@using Radzen
@using Radzen.Blazor
@inject NotificationService NotificationService

@implements IAsyncDisposable
@inject SignalRService SignalRService
@inject NavigationManager NavigationManager

<div class="row" style="height: calc(100vh - 100px);">
    <!-- Left Sidebar: Device List & Friend List -->
    <div class="col-md-3" style="height: 100%; overflow-y: auto; border-right: 1px solid #e0e0e0;">
        <RadzenCard Style="margin-bottom: 10px;">
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Select Device</RadzenText>
            <RadzenDropDown Data="@clients" ValueProperty="ConnectionId" 
                            @bind-Value="selectedConnectionId" Change="@OnClientSelected" 
                            Style="width: 100%;" Placeholder="Select a device..." >
                <Template Context="client">
                    @($"{client.device?.hsman} {client.device?.hstype} ({client.WeChatNick ?? "Unknown"})")
                </Template>
            </RadzenDropDown>
            
            @if (selectedClient != null)
            {
                <div style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
                    <RadzenText TextStyle="TextStyle.Caption">Current WeChat:</RadzenText>
                    <div style="display: flex; align-items: center;">
                        <RadzenIcon Icon="account_circle" Style="margin-right: 5px;" />
                        <div>
                            <div style="font-weight: bold;">@(selectedClient.WeChatNick ?? "Unknown")</div>
                            <div style="font-size: 0.8em; color: #666;">@(selectedClient.WeChatId ?? "Not logged in")</div>
                        </div>
                    </div>
                </div>
            }
        </RadzenCard>

        @if (contacts != null)
        {
             <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3" Style="margin: 10px 0;">Friends (@contacts.Count())</RadzenText>
             <RadzenListBox Data="@contacts" TextProperty="Nickname" ValueProperty="Wxid" 
                            @bind-Value="friendWxId" Change="@OnFriendSelected"
                            Style="height: calc(100% - 200px); width: 100%; border: none;" >
                <Template Context="contact">
                    <div style="display: flex; align-items: center;">
                        <RadzenImage Path="@(contact.Avatar)" Style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;" />
                        <div>
                            <div>@contact.Nickname</div>
                            <div style="font-size: 0.8em; color: #999;">@contact.Wxid</div>
                        </div>
                    </div>
                </Template>
             </RadzenListBox>
        }
    </div>
    
    <!-- Right Content: Chat Area -->
    <div class="col-md-9" style="height: 100%; display: flex; flex-direction: column;">
        @if (!string.IsNullOrEmpty(friendWxId))
        {
            <RadzenCard Style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                <div style="padding: 15px; border-bottom: 1px solid #eee; background-color: #f9f9f9;">
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Chat with @(selectedContact?.Nickname ?? friendWxId)</RadzenText>
                </div>

                <div id="chat-history" style="flex: 1; overflow-y: auto; padding: 20px; background-color: #fff;">
                    @foreach (var msg in messages.Where(m => m.FriendId == friendWxId || m.FriendId == "filehelper")) // Filter by friend
                    {
                        <div style="margin-bottom: 15px; display: flex; justify-content: @(msg.IsSent ? "flex-end" : "flex-start");">
                            <div style="max-width: 70%; padding: 10px 15px; border-radius: 15px; 
                                        background-color: @(msg.IsSent ? "#dcf8c6" : "#f1f0f0"); 
                                        color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                @msg.Content
                            </div>
                        </div>
                    }
                </div>

                <div style="padding: 15px; border-top: 1px solid #eee; background-color: #f9f9f9;">
                    <div class="row">
                        <div class="col-md-10">
                            <RadzenTextArea @bind-Value="messageContent" Rows="1" Style="width: 100%; border-radius: 20px; padding: 10px;" Placeholder="Type a message..." @onkeydown="@Enter" />
                        </div>
                        <div class="col-md-2">
                            <RadzenButton Icon="send" Click="@SendMessage" ButtonStyle="ButtonStyle.Primary" Style="width: 100%; border-radius: 20px;" Disabled="@(string.IsNullOrEmpty(selectedConnectionId) || string.IsNullOrEmpty(friendWxId) || string.IsNullOrEmpty(messageContent))" />
                        </div>
                    </div>
                </div>
            </RadzenCard>
        }
        else
        {
            <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #ccc;">
                <RadzenText TextStyle="TextStyle.H4">Select a friend to start chatting</RadzenText>
            </div>
        }
    </div>
</div>

@code {
    IEnumerable<SrClient> clients;
    IEnumerable<Contact> contacts;
    SrClient selectedClient;
    Contact selectedContact;
    string selectedConnectionId;
    string friendWxId; 
    string messageContent = "";
    List<ChatMessage> messages = new List<ChatMessage>();

    class ChatMessage
    {
        public string FriendId { get; set; }
        public string Content { get; set; }
        public bool IsSent { get; set; }
        public DateTime Time { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var hubUrl = "http://localhost:42718/hubs/client"; 
        await SignalRService.InitializeAsync(hubUrl);
        
        SignalRService.OnMessageReceived += OnMessageReceived;
        SignalRService.OnWeChatStatusChanged += OnWeChatStatusChanged;

        await LoadClients();

        // Join groups for all active clients
        if (clients != null)
        {
            foreach (var client in clients)
            {
                if (!string.IsNullOrEmpty(client.ConnectionId))
                {
                    await SignalRService.JoinGroupAsync(client.ConnectionId);
                }
            }
        }
    }

    private void OnMessageReceived(string friendId, string content, bool isSent)
    {
        // Only append if it belongs to the current conversation
        if (friendId == friendWxId)
        {
            messages.Add(new ChatMessage { FriendId = friendId, Content = content, IsSent = isSent, Time = DateTime.Now });
            InvokeAsync(StateHasChanged);
            // TODO: Scroll to bottom
        }
    }

    private void OnWeChatStatusChanged(string wxid, string nick, bool isOnline)
    {
        InvokeAsync(async () => {
            await LoadClients();
            if (selectedClient != null && selectedClient.WeChatId == wxid)
            {
                selectedClient.WeChatNick = nick;
                StateHasChanged();
            }
        });
    }

    async Task LoadClients()
    {
        clients = await SignalRService.GetDevicesAsync();
    }

    async Task OnClientSelected(object value)
    {
        var connId = value as string;
        selectedClient = clients.FirstOrDefault(c => c.ConnectionId == connId);
        friendWxId = null;
        selectedContact = null;
        contacts = null;

        if (selectedClient != null && selectedClient.WechatAccountId.HasValue)
        {
            contacts = await SignalRService.GetContactsAsync(selectedClient.WechatAccountId.Value);
        }
    }

    async Task OnFriendSelected(object value)
    {
        var wxid = value as string;
        selectedContact = contacts.FirstOrDefault(c => c.Wxid == wxid);
        
        if (selectedClient != null && selectedClient.WechatAccountId.HasValue && !string.IsNullOrEmpty(wxid))
        {
            var history = await SignalRService.GetChatHistoryAsync(selectedClient.WechatAccountId.Value, wxid);
            messages = history.Select(m => new ChatMessage 
            { 
                FriendId = m.Direction == 1 ? m.ReceiverWxid : m.SenderWxid,
                Content = m.Content,
                IsSent = m.Direction == 1,
                Time = m.CreatedAt
            }).ToList();
        }
    }

    async Task SendMessage()
    {
        if (string.IsNullOrEmpty(selectedConnectionId) || string.IsNullOrEmpty(friendWxId)) return;

        var result = await SignalRService.SendMessageAsync(selectedConnectionId, friendWxId, messageContent);

        if (result.Success)
        {
            messageContent = ""; 
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to send message: {result.Message}");
        }
    }

    async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await SendMessage();
        }
    }

    public async ValueTask DisposeAsync()
    {
        SignalRService.OnMessageReceived -= OnMessageReceived;
        SignalRService.OnWeChatStatusChanged -= OnWeChatStatusChanged;
        await SignalRService.DisposeAsync();
    }
}
